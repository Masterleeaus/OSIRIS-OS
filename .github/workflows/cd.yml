name: CD â€” deploy to Kubernetes via Helm

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: '1.27.0'
      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.12.0'
      - name: Decode Kubeconfig
        env:
          KUBE_CONFIG_B64: ${{ secrets.KUBE_CONFIG }}
        run: |
          echo "$KUBE_CONFIG_B64" | base64 --decode > kubeconfig
          export KUBECONFIG=$PWD/kubeconfig
          kubectl version --client
      - name: Helm upgrade (install)
        env:
          KUBECONFIG: ${{ github.workspace }}/kubeconfig
        run: |
          helm repo add stable https://charts.helm.sh/stable || true
          helm upgrade --install aiplatform ./deploy/helm/aiplatform --namespace ${GITHUB_ENV_NAMESPACE:-default} --set image.tag=${{ github.sha }} --wait
