{{ define "slack.default.title" }}{{ .CommonAnnotations.summary | title }}{{ end }}

{{ define "slack.default.text" }}
{{ if eq .Status "firing" }}:fire: *Alerting* :fire:{{ else }}:white_check_mark: *Resolved* :tada:{{ end }}

*Alert*: {{ .CommonAnnotations.summary }}
*Status*: {{ .Status | toUpper }}
*Severity*: {{ .CommonLabels.severity | toUpper }}
*Environment*: {{ .CommonLabels.environment | default "production" | toUpper }}

{{ if gt (len .Alerts.Firing) 0 }}
*Firing Alerts*:
{{ range .Alerts.Firing }}
â€¢ *Alert*: {{ .Annotations.summary }}
  *Description*: {{ .Annotations.description }}
  *Labels*: {{ range .Labels.SortedPairs }}{{ .Name }}="{{ .Value }}" {{ end }}
  *Time*: {{ .StartsAt | toTime | formatDate "2006-01-02 15:04:05 UTC" }}
  *Grafana*: {{ .GeneratorURL }}
  {{ if .Annotations.runbook_url }}*Runbook*: {{ .Annotations.runbook_url }}{{ end }}
{{ end }}
{{ end }}

{{ if gt (len .Alerts.Resolved) 0 }}
*Resolved Alerts*:
{{ range .Alerts.Resolved }}
â€¢ *Alert*: {{ .Annotations.summary }}
  *Resolved*: {{ .EndsAt | toTime | formatDate "2006-01-02 15:04:05 UTC" }}
  *Duration*: {{ .EndsAt.Sub .StartsAt | toTimeDuration }}
{{ end }}
{{ end }}

{{ if .CommonAnnotations.dashboard }}
*Dashboard*: {{ .CommonAnnotations.dashboard }}
{{ end }}

{{ if .CommonAnnotations.query }}
*Query*: {{ .CommonAnnotations.query }}
{{ end }}

*Alertmanager*: {{ .ExternalURL }}
{{ end }}

{{ define "email.default.subject" }}
{{ if eq .Status "firing" }}[FIRING] {{ .CommonAnnotations.summary }}{{ else }}[RESOLVED] {{ .CommonAnnotations.summary }}{{ end }}
{{ end }}

{{ define "email.default.html" }}
<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>{{ template "email.default.subject" . }}</title>
  <style>
    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
    .header { background-color: {{ if eq .Status "firing" }}#e74c3c{{ else }}#2ecc71{{ end }}; color: white; padding: 10px 20px; border-radius: 4px 4px 0 0; }
    .content { padding: 20px; border: 1px solid #e0e0e0; border-top: none; border-radius: 0 0 4px 4px; }
    .alert { margin-bottom: 15px; padding: 10px; border-left: 4px solid {{ if eq .Status "firing" }}#e74c3c{{ else }}#2ecc71{{ end }}; background-color: #f9f9f9; }
    .label { font-weight: bold; color: #555; }
    .footer { margin-top: 20px; font-size: 0.9em; color: #777; border-top: 1px solid #eee; padding-top: 10px; }
    .button { display: inline-block; padding: 8px 16px; background-color: #3498db; color: white; text-decoration: none; border-radius: 4px; font-weight: bold; }
    .firing { color: #e74c3c; font-weight: bold; }
    .resolved { color: #2ecc71; font-weight: bold; }
    table { width: 100%; border-collapse: collapse; margin: 10px 0; }
    th { text-align: left; background-color: #f2f2f2; padding: 8px; }
    td { padding: 8px; border-bottom: 1px solid #ddd; }
  </style>
</head>
<body>
  <div class="header">
    <h2>{{ if eq .Status "firing" }}ðŸš¨ ALERT: {{ .CommonAnnotations.summary }}{{ else }}âœ… RESOLVED: {{ .CommonAnnotations.summary }}{{ end }}</h2>
  </div>
  
  <div class="content">
    <div class="alert">
      <p><span class="label">Status:</span> <span class="{{ .Status }}">{{ .Status | toUpper }}</span></p>
      <p><span class="label">Severity:</span> {{ .CommonLabels.severity | toUpper }}</p>
      <p><span class="label">Environment:</span> {{ .CommonLabels.environment | default "production" | toUpper }}</p>
    </div>

    {{ if gt (len .Alerts.Firing) 0 }}
    <h3>ðŸ”´ Firing Alerts ({{ len .Alerts.Firing }})</h3>
    <table>
      <thead>
        <tr>
          <th>Alert</th>
          <th>Description</th>
          <th>Since</th>
          <th>Details</th>
        </tr>
      </thead>
      <tbody>
        {{ range .Alerts.Firing }}
        <tr>
          <td><strong>{{ .Annotations.summary }}</strong></td>
          <td>{{ .Annotations.description }}</td>
          <td>{{ .StartsAt | toTime | formatDate "2006-01-02 15:04:05 UTC" }}</td>
          <td><a href="{{ .GeneratorURL }}" class="button">View in Grafana</a></td>
        </tr>
        <tr>
          <td colspan="4">
            <small>
              <strong>Labels:</strong> 
              {{ range $key, $value := .Labels }}
                {{ $key }}="{{ $value }}" 
              {{ end }}
              {{ if .Annotations.runbook_url }}
                <br><strong>Runbook:</strong> <a href="{{ .Annotations.runbook_url }}">{{ .Annotations.runbook_url }}</a>
              {{ end }}
            </small>
          </td>
        </tr>
        {{ end }}
      </tbody>
    </table>
    {{ end }}

    {{ if gt (len .Alerts.Resolved) 0 }}
    <h3>âœ… Resolved Alerts ({{ len .Alerts.Resolved }})</h3>
    <table>
      <thead>
        <tr>
          <th>Alert</th>
          <th>Resolved</th>
          <th>Duration</th>
        </tr>
      </thead>
      <tbody>
        {{ range .Alerts.Resolved }}
        <tr>
          <td><strong>{{ .Annotations.summary }}</strong></td>
          <td>{{ .EndsAt | toTime | formatDate "2006-01-02 15:04:05 UTC" }}</td>
          <td>{{ .EndsAt.Sub .StartsAt | toTimeDuration }}</td>
        </tr>
        {{ end }}
      </tbody>
    </table>
    {{ end }}

    <div class="footer">
      <p>This alert was triggered by Alertmanager at {{ .StartsAt | toTime | formatDate "2006-01-02 15:04:05 UTC" }}</p>
      <p><a href="{{ .ExternalURL }}">View in Alertmanager</a></p>
      {{ if .CommonAnnotations.dashboard }}
      <p><a href="{{ .CommonAnnotations.dashboard }}">View Dashboard</a></p>
      {{ end }}
    </div>
  </div>
</body>
</html>
{{ end }}

{{ define "pagerduty.default.description" }}
{{ if eq .Status "firing" }}[FIRING] {{ .CommonAnnotations.summary }}{{ else }}[RESOLVED] {{ .CommonAnnotations.summary }}{{ end }}
{{ end }}

{{ define "pagerduty.default.details" }}
{
  "firing": "{{ .Alerts.Firing | len }}",
  "resolved": "{{ .Alerts.Resolved | len }}",
  "status": "{{ .Status }}",
  "severity": "{{ .CommonLabels.severity }}",
  "environment": "{{ .CommonLabels.environment | default "production" }}",
  "summary": "{{ .CommonAnnotations.summary }}",
  "description": "{{ .CommonAnnotations.description }}",
  "runbook_url": "{{ .CommonAnnotations.runbook_url }}",
  "dashboard_url": "{{ .CommonAnnotations.dashboard }}",
  "alertmanager_url": "{{ .ExternalURL }}",
  "alerts": [
    {{ range $i, $alert := .Alerts }}
    {
      "status": "{{ $alert.Status }}",
      "startsAt": "{{ $alert.StartsAt }}",
      "endsAt": "{{ $alert.EndsAt }}",
      "generatorURL": "{{ $alert.GeneratorURL }}",
      "labels": {
        {{ range $key, $value := $alert.Labels }}
        "{{ $key }}": "{{ $value }}"{{ if not $loop.Last }},{{ end }}
        {{ end }}
      },
      "annotations": {
        {{ range $key, $value := $alert.Annotations }}
        "{{ $key }}": "{{ $value }}"{{ if not $loop.Last }},{{ end }}
        {{ end }}
      }
    }{{ if not $loop.Last }},{{ end }}
    {{ end }}
  ]
}
{{ end }}
